# src/gui/text_diff_viewer.py 分析文档

## 1. 文件概述

**文件路径**：`src/gui/text_diff_viewer.py`
**功能定位**：提供文本对比视图组件，用于显示文本修改前后的差异。
**核心类**：`TextDiffViewer`
**技术栈**：PyQt6

## 2. 核心实现分析

### 2.1 TextDiffViewer 类

**功能**：提供分屏对比视图，显示原始文本和修改后的文本，并高亮显示差异。

#### 2.1.1 类属性

| 属性名 | 类型 | 描述 |
|-------|------|------|
| original_text | str | 原始文本内容 |
| modified_text | str | 修改后的文本内容 |
| original_text_edit | QTextEdit | 原始文本显示控件 |
| modified_text_edit | QTextEdit | 修改后文本显示控件 |
| stats_label | QLabel | 差异统计信息标签 |

#### 2.1.2 核心方法

**`__init__(self, original_text: str, modified_text: str, parent: Optional[QWidget] = None)`**
- **功能**：初始化文本对比视图
- **参数**：`original_text` - 原始文本，`modified_text` - 修改后的文本，`parent` - 父组件
- **实现细节**：
  - 保存原始文本和修改后文本
  - 初始化UI界面
  - 高亮显示差异

**`_init_ui(self) -> None`**
- **功能**：构建文本对比视图的用户界面
- **实现细节**：
  - 设置窗口标题和大小
  - 创建标题区域，显示"原始文本"和"修改后文本"
  - 创建分屏对比组件（使用QSplitter实现左右分屏）
  - 添加统计信息标签和关闭按钮
  - 设置样式表

**`_highlight_differences(self) -> None`**
- **功能**：高亮显示文本差异
- **实现细节**：
  - 使用简单的逐行比较算法检测差异
  - 创建高亮格式（删除行使用浅红色背景，添加行使用浅绿色背景）
  - 高亮原始文本中的删除行
  - 高亮修改后文本中的添加行
  - 统计并显示差异信息（添加行数、删除行数、修改行数）

### 2.2 show_text_diff 函数

**功能**：显示文本对比对话框的便捷函数
**参数**：`original_text` - 原始文本，`modified_text` - 修改后的文本，`parent` - 父组件
**实现细节**：创建TextDiffViewer实例并执行

## 3. 与其他模块的关系

| 依赖模块 | 依赖关系 | 使用方式 |
|---------|---------|---------|
| `PyQt6.QtWidgets` | 界面框架 | 使用QDialog、QSplitter、QTextEdit等组件构建UI |
| `PyQt6.QtCore` | 核心功能 | 使用Qt等核心组件 |
| `PyQt6.QtGui` | 图形库 | 使用QTextCharFormat、QColor等实现文本高亮 |
| `logging` | 日志记录 | 记录文本对比相关操作和事件 |

## 4. 代码结构与设计模式

```
TextDiffViewer (QDialog)
├── __init__()
├── _init_ui()
└── _highlight_differences()

show_text_diff()  # 便捷函数
```

**设计特点**：
- 采用对话框模式，便于用户查看和比较文本差异
- 使用分屏布局，直观展示原始文本和修改后的文本
- 采用行级差异检测算法，简单高效
- 提供差异统计信息，方便用户了解修改范围
- 支持自定义样式，提升用户体验

## 5. 潜在改进点

1. **差异检测算法优化**：
   - 当前使用简单的逐行比较，可考虑使用更复杂的算法（如Myers差分算法）实现更精确的差异检测
   - 支持字符级差异高亮

2. **功能扩展**：
   - 添加差异导航功能（上一个差异/下一个差异）
   - 支持忽略空格和大小写差异
   - 提供复制差异文本功能

3. **用户体验优化**：
   - 添加横向滚动同步功能
   - 支持折叠无差异的文本块
   - 提供不同的差异高亮主题

4. **性能优化**：
   - 针对大文件进行性能优化
   - 实现异步差异检测，避免界面卡顿

## 6. 总结

`src/gui/text_diff_viewer.py`实现了一个文本对比视图组件，用于显示文本修改前后的差异。该组件采用分屏布局，直观展示原始文本和修改后的文本，并通过高亮显示差异行帮助用户快速识别修改内容。

核心特点包括：
- 分屏显示原始文本和修改后的文本
- 行级差异高亮（删除行使用浅红色，添加行使用浅绿色）
- 提供差异统计信息（添加行数、删除行数、修改行数）
- 简洁直观的用户界面
- 便捷的函数式调用方式

该组件在系统中主要用于显示文本修改前后的差异，提升了用户查看和理解修改内容的效率。虽然当前实现采用了简单的差异检测算法，但在大多数场景下已经能够满足基本需求。未来可以通过优化差异检测算法和扩展功能，进一步提升该组件的实用性和用户体验。